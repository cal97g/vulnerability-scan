import typing
import ipaddress

from flask import Flask
from flask import current_app
from flask import request

from core import celery as celery_tasks


def create_app() -> Flask:
    app = Flask(__name__)
    @app.route("/", methods=["GET"])
    def page():
        return """
        <html>
            <form action="/" method="POST">
                <input id="cidr" name="cidr" type="text" default="cidr"/>
                <input type="submit" value="Start Scan">
            </form>
        </html>
        """

    @app.route("/", methods=["POST"])
    def handle_start():
        try:
            celery_tasks.initialise_scan.delay(
                ipaddress.IPv4Network(request.data["cidr"])
            )

            return """
            Scan of range:
            {}

            Constituents:
            {}
            """.format(
                request.data["cidr"],
                str([str(ip) for ip in ipaddress.IPv4Network(request.data["cidr"])])
            ), 201
        except ValueError as e:
            return """
            {}

            Invalid CIDR, try again
            """.format(str(e)), 400




    return app

def setup_app(config: typing.Object) -> Flask:
